# ダンジョン選択システム設計

## 概要

複数のダンジョンをハブから選択して挑戦できるシステム。
ダンジョンごとに壁の種類、ステージ構成、敵の種類が異なる。

## 要件

- ダンジョンによって壁の種類、ステージ、敵の種類が変わる
- ハブから選んで移動
- ダンジョンには階層がある
- 最深層にボスがいる
- 階層間の移動はポータル
- 5階ごとに脱出可能

## 設計

### 1. PlannerType（純粋にステージ構造のみ）

PlannerTypeはステージの構造だけを定義。
WallType、敵/アイテムテーブルはダンジョン側で管理。

```go
// internal/mapplanner/lib.go
type PlannerType struct {
    Name              string
    SpawnEnemies      bool
    SpawnItems        bool
    UseFixedPortalPos bool
    PlannerFunc       func(width, height gc.Tile, seed uint64) (*PlannerChain, error)
    // WallType, ItemTableName, EnemyTableName は削除 → ダンジョン側で管理
}

// 例: ステージ構造のみ定義
var PlannerTypeForest = PlannerType{
    Name:         "森",
    SpawnEnemies: true,
    SpawnItems:   true,
    PlannerFunc:  NewForestPlanner,
}

var PlannerTypeSmallRoom = PlannerType{
    Name:         "小部屋",
    SpawnEnemies: true,
    SpawnItems:   true,
    PlannerFunc:  NewSmallRoomPlanner,
}

var PlannerTypeCave = PlannerType{
    Name:         "洞窟",
    SpawnEnemies: true,
    SpawnItems:   true,
    PlannerFunc:  NewCavePlanner,
}
```

### 2. DungeonDefinition

ダンジョン単位で全設定を管理。階層ごとの変化は敵テーブル内で対応。

```go
// internal/dungeon/definition.go
package dungeon

type DungeonDefinition struct {
    Name           string
    Description    string
    TotalFloors    int              // 総階層数
    EnemyTableName string           // 敵テーブル
    ItemTableName  string           // アイテムテーブル
    PlannerPool    []PlannerWeight  // 使用するステージ種類
}

type PlannerWeight struct {
    PlannerType mapplanner.PlannerType
    Weight      int
}
```

**設計意図:**
- WallTypeはPlannerごとに指定（森ステージは木の壁、小部屋はレンガなど）
- 階層ごとの難易度変化は敵テーブル側で対応

### 3. 定義例

```go
var DungeonForest = DungeonDefinition{
    Name:           "迷いの森",
    Description:    "木々が生い茂る危険な森",
    TotalFloors:    10,
    MinLevel:       1,
    EnemyTableName: "森",
    ItemTableName:  "森",
    PlannerPool: []PlannerWeight{
        {
            PlannerType: PlannerTypeForest,
            Weight:      5,
        },
        {
            PlannerType: PlannerTypeSmallRoom,
            Weight:      2,
        },
        {
            PlannerType: PlannerTypeBigRoom,
            Weight:      1,
        },
    },
}

var DungeonCave = DungeonDefinition{
    Name:           "暗い洞窟",
    Description:    "光の届かない深い洞窟",
    TotalFloors:    15,
    MinLevel:       5,
    EnemyTableName: "洞窟",
    ItemTableName:  "洞窟",
    PlannerPool: []PlannerWeight{
        {
            PlannerType: PlannerTypeCave,
            Weight:      6,
        },
        {
            PlannerType: PlannerTypeSmallRoom,
            Weight:      1,
        },
        {
            PlannerType: PlannerTypeBigRoom,
            Weight:      2,
        },
    },
}

var DungeonRuins = DungeonDefinition{
    Name:           "古代遺跡",
    Description:    "かつて栄えた文明の跡",
    TotalFloors:    20,
    MinLevel:       10,
    EnemyTableName: "遺跡",
    ItemTableName:  "遺跡",
    PlannerPool: []PlannerWeight{
        {
            PlannerType: PlannerTypeSmallRoom,
            Weight:      4,
        },
        {
            PlannerType: PlannerTypeRuins,
            Weight:      3,
        },
        {
            PlannerType: PlannerTypeBigRoom,
            Weight:      2,
        },
    },
}
```

### 4. フロー

```
ハブ(NPC/ゲート)
    ↓
DungeonSelectState (UI: ダンジョン一覧)
    ↓ 選択
DungeonDefinition 取得
    ↓
PlannerPool から重み付き抽選 → PlannerWeight
    ↓
Plan() 実行
  - PlannerWeight.Config.WallType でタイル描画
  - DungeonDefinition.EnemyTableName + 現在階層 でスポーン
    ↓
DungeonState 開始
    ↓
ポータル到達
    ├─ 次階層へ → 新マップ生成
    ├─ 5階ごと → 脱出選択可能
    └─ 最深層 → ボス戦 → クリア
```

### 5. ファイル構成

```
internal/dungeon/
├── doc.go             # パッケージ説明
├── definition.go      # DungeonDefinition, PlannerWeight
├── registry.go        # 全ダンジョンの登録・取得
├── selector.go        # PlannerPool からの抽選ロジック
└── progress.go        # 階層進行管理（現在何階か、セーブ/ロード）

internal/states/
├── dungeon_select.go  # ダンジョン選択UI State
└── dungeon.go         # 既存（階層管理を追加）
```

### 6. UI設計

#### ダンジョン選択画面

```
┌─────────────────────────────────┐
│       ダンジョン選択            │
├─────────────────────────────────┤
│ ▶ 迷いの森      Lv.1~   10階   │
│   暗い洞窟      Lv.5~   15階   │
│   古代遺跡      Lv.10~  20階   │
│   ???           ???     ???    │  ← 未解放
├─────────────────────────────────┤
│ [決定]  [戻る]                  │
└─────────────────────────────────┘
```

#### ダンジョン内ポータル（脱出可能階）

```
┌─────────────────────────────────┐
│     迷いの森 B5F - ポータル     │
├─────────────────────────────────┤
│ ▶ 次の階層へ進む                │
│   街へ脱出する                  │
├─────────────────────────────────┤
│ [決定]  [キャンセル]            │
└─────────────────────────────────┘
```

### 8. 今後の拡張案

- ダンジョン固有のギミック（毒沼、溶岩など）
- ランダムイベント（宝箱部屋、商人など）
- 難易度選択
- 周回ボーナス
