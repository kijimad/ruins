# シード管理設計

## 概要

ゲームの乱数を管理し、再現可能なゲームプレイを実現する。

- **ステージ生成**: stageSeed で再現可能（深度に依存しない）
- **ゲームプレイ**: world.Config.RNG を使用（同じ操作なら再現可能）

## 初期化フロー

### 1. Config読み込み時 (`config.Load()`)

```go
// 環境変数 RUINS_SEED が設定されている場合
if os.Getenv("RUINS_SEED") != "" {
    cfg.Seed = 環境変数の値
} else {
    // 未設定の場合はランダム生成
    cfg.Seed = rand.Uint64()
}

// SeedからRNGを生成
cfg.RNG = rand.New(rand.NewPCG(cfg.Seed, 0))
```

### 2. ステージ生成時 (`DungeonState.OnStart()`)

```go
// ステージ用シードをRNGから生成
stageSeed := world.Config.RNG.Uint64()

// SelectPlanner用のRNGはstageSeedから生成
stageRNG := rand.New(rand.NewPCG(stageSeed, 0))
builderType, err := dungeon.SelectPlanner(def, stageRNG)

// PlanにはstageSeedを渡す（内部で独自にRNGを作成）
plan, err := mapplanner.Plan(world, ..., stageSeed, builderType)
```

### 3. ゲームプレイ中

```go
// 戦闘、ドロップなどは world.Config.RNG を使用
weaponName, err := commandTable.SelectByWeight(world.Config.RNG)
materialName, err := dropTable.SelectByWeight(world.Config.RNG)
```

## 再現性

| シナリオ | 再現性 |
|---------|--------|
| 同じ RUINS_SEED + 同じ操作 | 完全再現可能 |
| 同じ stageSeed | 同じステージを再現可能 |
| 異なる操作 | ステージは同じ、以降は異なる |

## RNG使用箇所

| 用途 | 使用するRNG |
|------|------------|
| プランナー選択 | stageSeed から生成した RNG |
| マップ生成 | stageSeed（Plan内部でRNG作成） |
| 攻撃選択 | world.Config.RNG |
| ドロップ選択 | world.Config.RNG |
