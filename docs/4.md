# 戦闘システムを再設計する

## コンセプト

**アイテム収集を阻む要素としての戦闘**

- ゲーム全体のコアの面白さ: アイテム収集。アイテム収集が活きる
- 戦闘: シンプルで速く、判断が重要
- バランス: 知識とアイテムで優位に立てる

コアはアイテム収集と活用であって、戦闘そのものはエッセンスだけを表現する。演出や手間は最小限で、あっさりでよい。

## 設計原則

### 1. 位置取りの重要性

```
遠距離 → 射撃有利 → 先制攻撃可能
中距離 → 地形ボーナス → 準備が重要
近距離 → 地形ボーナス活用
隣接   → 強制戦闘 → 不利（避けたい状況）
```

### 2. 事前準備の価値

- どこで交戦するかを選択できる
- 有利な位置を探せる
- 適切なアイテムで条件を有利にできる

### 3. リスク管理

- 1体ずつ処理: 安全だが時間がかかる
- 複数まとめて: 危険だが速い
- チェイン戦闘: 近隣の敵が連鎖して強くなる

## 戦闘フロー

### 準備フェーズ

#### 状況確認
- 敵の情報（HP、武器、特性）
- 距離（遠い/近い/隣接）
- 地形ボーナス
- 連鎖する敵の数

#### ボーナス計算
- 遠距離ボーナス: +60%
- 近距離ボーナス（自分のタイル種別）: +20%

### 選択フェーズ

#### 1. 射撃（距離があるときのみ、0~1つ選択）
- ハンドガン
- ライフル
- 射撃しない

#### 2. 近接（必須、1つ選択）
- 日本刀
- 斧
- 素手

#### 3. 補助アイテム（複数選択可能）
- 手榴弾: 射撃フェーズで固定ダメージ
- 煙幕: 敵の射撃命中率が低下

### 実行フェーズ

#### 1. 射撃フェーズ
- 味方と敵が射撃選択肢を持つ場合のみ実行
- 命中判定
- ダメージ計算
- 補助アイテム効果適用

#### 2. 近接フェーズ
- 必ず発生
- 命中判定
- ダメージ計算

## 戦闘の特徴

### 逃亡について
- 戦闘上の選択肢にはない
- タイル上で敵と距離をとることで回避
- 探索中の立ち回りが重要

### 強制戦闘
- 隣接した場合は強制的に戦闘
- 不利な条件になる
- 避けるべき状況

### チェイン戦闘
- 近隣に複数の敵がいるときに交戦すると発生
- 敵が強くなり、被害が増加
- リスクとリターンの判断

## データ構造

### 戦闘状況
```go
type CombatSituation struct {
    Player         Entity
    Enemies        []Entity
    Distance       DistanceType // Far, Medium, Close, Adjacent
    TerrainBonus   int          // プレイヤーのタイル種別ボーナス
    ChainedEnemies int          // 連鎖する敵の数
}
```

### 選択可能なオプション
```go
type CombatOptions struct {
    RangedWeapons  []Weapon     // 距離があれば選択可能
    MeleeWeapons   []Weapon     // 必須（素手含む）
    SupportItems   []Item       // 複数選択可能
}
```

### プレイヤーの選択
```go
type CombatChoice struct {
    RangedWeapon   *Weapon      // nilなら射撃しない
    MeleeWeapon    Weapon       // 必須
    SupportItems   []Item       // 使用するアイテム
}
```

### 戦闘結果
```go
type CombatResult struct {
    Phases []PhaseResult
    TotalDamage      int
    AmmoUsed         map[string]int
    ItemsUsed        []string
    Success          bool
}

type PhaseResult struct {
    Phase      PhaseType // Ranged or Melee
    PlayerHit  bool
    EnemyHit   bool
    Damage     int
    HitRate    float64
}
```

## UIイメージ

```
========================================
予測                  装備選択
地形情報
敵情報
自情報
========================================
```

```
========================================
[装備選択]

□ 射撃フェーズ (選択可能)
  ○ ハンドガン (重弾薬, 命中70%)
  ○ ライフル (軽弾薬, 命中85%, 高威力)
  ○ 射撃しない

□ 近接武器 (必須)
  ○ 日本刀 (高威力, 耐久-1)
  ○ 斧 (中威力)
  ○ 素手 (低威力)

□ 補助アイテム (複数可)
  □ 手榴弾 (射撃フェーズ固定30dmg)
  □ 煙幕 (敵の射撃-50%)
========================================
[地形情報]
距離: 遠距離 (12)
地形: 森
========================================
[敵情報]
ゴブリン(弓)、ゴブリン(斧) ... 1シンボル = 1キャラ。近距離連鎖で2つの敵になっている

敵情報:
- ゴブリン(弓+素手): HP15 ... (芝生、瓦礫)
- ゴブリン(斧): HP15 ... (泥)
========================================
[自情報]
戦闘関係あるステータスなど
========================================
[予測]
射撃: 被害 4~6dmg
近接: 被害 10~24dmg

被害予測: HP 20~30 銃弾 2~6個 ... HPが0以下になるとゲームオーバー

[決定] [キャンセル]
========================================
```

## 戦闘ロジック

### 戦力計算の基本

戦略ゲーム的なロジック：**自分と相手の戦力差によって被害が決定する**

```
プレイヤー戦力 vs 敵戦力 → 被害の計算
```

### 戦力の構成要素

#### プレイヤー戦力
```go
PlayerPower = {
    武器攻撃力 +
    ステータスボーナス (筋力、器用さなど) +
    装備ボーナス (鎧、盾など) +
    地形ボーナス +
    距離ボーナス +
    アイテムボーナス (手榴弾、煙幕など)
}
```

#### 敵戦力
```go
EnemyPower = {
    敵の武器攻撃力 +
    敵のステータス +
    敵の装備 +
    敵の地形ボーナス +
    チェイン数によるボーナス (複数敵)
}
```

### 被害計算式

```go
// 射撃フェーズ
if 射撃あり {
    PlayerRangedPower = 武器攻撃力 + 命中率補正 + 距離ボーナス + 器用さ
    EnemyRangedPower = 敵の射撃力 - 煙幕効果

    PlayerDamage = max(0, EnemyRangedPower - PlayerDefense)
    EnemyDamage = max(0, PlayerRangedPower - EnemyDefense)
}

// 近接フェーズ (必ず発生)
PlayerMeleePower = 武器攻撃力 + 筋力 + 地形ボーナス
EnemyMeleePower = 敵の近接力 + チェインボーナス

PlayerDamage = max(0, EnemyMeleePower - PlayerDefense)
EnemyDamage = max(0, PlayerMeleePower - EnemyDefense)
```

### 戦力差による結果の例

```
[圧倒的優位]
プレイヤー戦力 100 vs 敵戦力 30
→ プレイヤー被害: 0~2
→ 敵被害: 70以上 (確実に倒せる)

[優位]
プレイヤー戦力 70 vs 敵戦力 50
→ プレイヤー被害: 5~15
→ 敵被害: 20~30

[互角]
プレイヤー戦力 60 vs 敵戦力 60
→ プレイヤー被害: 15~25
→ 敵被害: 15~25

[不利]
プレイヤー戦力 40 vs 敵戦力 70
→ プレイヤー被害: 30~50 (危険!)
→ 敵被害: 5~15
```

### 戦力差の可視化

UIで戦力バーを表示:

```
[装備選択後の戦力比較]

射撃フェーズ:
プレイヤー: ████████░░ 80
敵        : ████░░░░░░ 40
→ 有利! (被害予測: 2~6dmg)

近接フェーズ:
プレイヤー: ██████░░░░ 60
敵        : ████████░░ 80
→ 不利! (被害予測: 15~30dmg)

総合予測: HP 17~36減少
```

### 乱数の扱い

```go
// 基本ダメージ計算
baseDamage = AttackPower - Defense

// 乱数幅を持たせる (±20%)
actualDamage = baseDamage * (0.8 + rand(0.4))

// 命中判定
if rand(100) < HitRate {
    // ダメージ適用
} else {
    // ミス
}
```

### 戦力の調整要素

1. **装備選択**: 最も影響が大きい
   - ライフル vs ハンドガン: 射撃戦力+30
   - 日本刀 vs 素手: 近接戦力+40

2. **アイテム**: 状況を一時的に改善
   - 手榴弾: 射撃戦力+30 (固定ダメージ)
   - 煙幕: 敵の射撃戦力-50%

3. **地形・距離**: 位置取りの価値
   - 遠距離: +60% 射撃戦力
   - 森タイル: +20% 全戦力

4. **ステータス**: 長期的な成長
   - 筋力+10: 近接戦力+10%
   - 器用さ+10: 射撃戦力+10%

## バランス設計の参考

### CDDAからの学び
- 低知能AI + 物量
- 立ち回りの理解で対処可能
- 「理解すれば安全」という学習曲線
- 戦闘は「邪魔な障害」程度に

### FTLからの学び
- イベント選択肢による判断
- 準備（装備・アイテム）が重要
- テンポが良い戦闘

### DCSSからの学び
- 完全情報（敵のステータスが見える）
- 知識による優位性
- 逃げるのも戦術の一つ

## 設計の意図

### 習熟による優位性
```
[初見プレイ]
→ 判断材料が少ない
→ 失敗する

[2回目]
→ 敵の特性を学習
→ 少し改善

[習熟後]
→ 最適な装備・位置・アイテムを選択
→ ほぼ無傷で勝利
```

### アイテムの価値
- 手榴弾: 遠距離優位を強化
- 煙幕: 近接特化ビルドの保険
- 適切なアイテムがあれば確実に勝てる

### 知識の価値
- 敵図鑑（倒すと特性が判明）
- どの武器が有効か
- どの地形が有利か

## 実装の優先順位

### Phase 1: 最小構成のプロトタイプ
- 1種類の敵
- 射撃1種、近接1種
- 補助アイテムなし
- 距離は「遠い/近い」の2段階

### Phase 2: 検証
- 判断は面白いか？
- 予測と結果のズレは気持ち良いか？
- もう1回やりたいか？
- 学習曲線は適切か？

### Phase 3: 拡張
- 敵の種類を増やす
- 武器・アイテムのバリエーション
- 地形効果の追加
- 特殊効果（クリティカル等）

### クリティカルや特殊効果
```
日本刀: 20%で即死
手榴弾: 複数の敵に有効
盾: 被ダメージ-30%
```
→ アイテムの差別化

### 戦闘後の状態表示
```
[戦闘終了]
被害: HP-12
消費: 弾薬-1, 日本刀の耐久-1

ドロップ:
- 矢×5
- 革の盾
```
